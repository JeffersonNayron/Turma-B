<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸš‚ Revezamento Turma B</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <style>
    .quantidade-equipes {
      text-align: center;
      font-size: 0.9rem;
      color: #555;
      margin-top: -0.3rem;
      margin-bottom: 1rem;
      font-weight: 500;
    }
    .segundos {
      color: #aaa;
      font-size: 0.85em;
    }
    td.hora-inicio {
      cursor: pointer;
      user-select: none;
    }
    .mensagem-display {
      font-style: italic;
      color: #004085;
      background: #cce5ff;
      padding: 6px 10px;
      border-radius: 6px;
      margin-top: 4px;
      text-align: left;
      white-space: pre-wrap;
    }
  </style>
</head>

<body class="container py-4">
  <h1 class="fw-bold logo">ðŸš‚ Revezamento Turma B</h1>
  <p class="quantidade-equipes">Quantidade de equipes: <span id="contadorPessoas">0</span></p>

  <form id="formPessoa" class="mb-4">
    <input type="text" name="nome" class="form-control" placeholder="Nome" required autocomplete="off" />
    <select name="local" id="local" class="form-select" required>
      <option value="" disabled selected>Selecione o local</option>
      <option value="X6">X6</option>
      <option value="X5">X5</option>
      <option value="PIAL/OFC">PIAL/OFC</option>
      <option value="VV">VV</option>
    </select>
    <button class="btn btn-success" type="submit">Adicionar</button>
    <button type="button" onclick="limparDados()" class="btn btn-outline-danger">Limpar</button>
  </form>

  <div class="table-responsive">
    <table class="table table-bordered table-hover align-middle text-center">
      <thead>
        <tr>
          <th>Status</th>
          <th>Nome</th>
          <th>Local</th>
          <th>InÃ­cio</th>
          <th>Final</th>
          <th>AÃ§Ãµes</th>
        </tr>
      </thead>
      <tbody id="tabelaCorpo"></tbody>
    </table>
  </div>

<script>
  let estaEditandoId = null;
  let estaEditandoMensagem = false;

  const urlParams = new URLSearchParams(window.location.search);
  const isAdmin = urlParams.get('adm') === '1';

  function carregarPessoas() {
    fetch('/pessoas')
      .then(res => res.json())
      .then(data => {
        const tbody = document.getElementById('tabelaCorpo');
        tbody.innerHTML = '';
        document.getElementById('contadorPessoas').textContent = data.length;

        function formatarHora(hora) {
          if (!hora) return '-';
          return hora.replace(/(\d{2}:\d{2})(:\d{2})/, "$1<span class='segundos'>$2</span>");
        }

        data.forEach(p => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="status">${p.status}</td>
            <td>${p.nome}</td>
            <td class="${p.local === 'PIAL/OFC' ? 'local-pial-ofc' : ''}">
              <span class="local-display" onclick="editarLocal(this, ${p.id})">${p.local}</span>
            </td>
            <td id="inicio-${p.id}" class="hora-inicio" data-id="${p.id}">${formatarHora(p.hora_inicio)}</td>
            <td id="fim-${p.id}">${formatarHora(p.hora_fim)}</td>
            <td class="actions">
              <button class="btn btn-warning btn-sm" onclick="iniciar(${p.id})">Iniciar</button>
              <button class="btn btn-danger btn-sm" onclick="excluir(${p.id})">Excluir</button>
            </td>
          `;
          tbody.appendChild(tr);

          const trMsg = document.createElement('tr');
          const msgTexto = p.mensagem || '';
          let campoMensagem = '';

          if(isAdmin) {
            campoMensagem = `
              <div class="input-group input-group-sm">
                <input type="text" id="msg-${p.id}" class="form-control" placeholder="Escreva uma mensagem para ${p.nome}" value="${msgTexto.replace(/"/g, '&quot;')}" />
                <button class="btn btn-primary" onclick="enviarMensagem(${p.id})">Enviar</button>
              </div>
            `;
          } else {
            campoMensagem = msgTexto ? `<div class="mensagem-display">${msgTexto}</div>` : '';
          }

          trMsg.innerHTML = `
            <td colspan="6" style="padding: 0.25rem 1rem;">
              ${campoMensagem}
              <div id="msg-feedback-${p.id}" style="margin-top: 0.25rem; font-size: 0.85em;"></div>
            </td>
          `;
          tbody.appendChild(trMsg);
        });

        if (estaEditandoId === null) {
          document.querySelectorAll('.hora-inicio').forEach(td => {
            td.onclick = () => {
              const id = td.getAttribute('data-id');
              const texto = td.textContent.trim();
              editarHoraInicio(td, id, texto);
            };
          });
        }

        adicionarListenersMensagem();
      });
  }

  function adicionarListenersMensagem() {
    document.querySelectorAll('input[id^="msg-"]').forEach(input => {
      input.onfocus = () => estaEditandoMensagem = true;
      input.onblur = () => estaEditandoMensagem = false;
    });
  }

  function enviarMensagem(id) {
    const input = document.getElementById(`msg-${id}`);
    const mensagem = input.value.trim();
    const feedback = document.getElementById(`msg-feedback-${id}`);

    if (!mensagem) {
      feedback.style.color = 'red';
      feedback.textContent = 'Digite uma mensagem antes de enviar.';
      return;
    }

    fetch('/enviarMensagem', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ id, mensagem })
    }).then(res => {
      if(!res.ok) throw new Error('Erro ao enviar');
      feedback.style.color = 'green';
      feedback.textContent = 'Mensagem enviada com sucesso!';
      estaEditandoMensagem = false;
      carregarPessoas();
    }).catch(() => {
      feedback.style.color = 'red';
      feedback.textContent = 'Erro ao enviar mensagem.';
    });
  }

  function editarHoraInicio(td, id, horaAtual) {
    estaEditandoId = id;
    const valorInput = horaAtual.length >= 5 ? horaAtual.slice(0,5) : '';
    const input = document.createElement('input');
    input.type = 'time';
    input.className = 'form-control form-control-sm';
    input.value = valorInput;
    input.style.maxWidth = '110px';
    td.innerHTML = '';
    td.appendChild(input);
    input.focus();

    function salvar() {
      if (!input.value) return cancelar();
      const [h, m] = input.value.split(':');
      if(h === undefined || m === undefined) return cancelar();

      const dtInicio = new Date();
      dtInicio.setHours(parseInt(h), parseInt(m), 0, 0);
      const dtFim = new Date(dtInicio.getTime() + 75*60000);
      const hhFim = dtFim.getHours().toString().padStart(2,'0');
      const mmFim = dtFim.getMinutes().toString().padStart(2,'0');
      const ssFim = '00';

      const hora_inicio = `${input.value}:00`;
      const hora_fim = `${hhFim}:${mmFim}:${ssFim}`;

      fetch('/editarHorario', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id, hora_inicio, hora_fim })
      }).then(() => {
        estaEditandoId = null;
        carregarPessoas();
      }).catch(() => {
        estaEditandoId = null;
        carregarPessoas();
      });
    }

    function cancelar() {
      estaEditandoId = null;
      carregarPessoas();
    }

    input.onblur = () => salvar();
    input.onkeydown = (e) => {
      if(e.key === 'Enter') {
        e.preventDefault();
        salvar();
      }
      if(e.key === 'Escape') {
        e.preventDefault();
        cancelar();
      }
    };
  }

  document.getElementById('formPessoa').addEventListener('submit', e => {
    e.preventDefault();
    const form = new FormData(e.target);
    fetch('/adicionar', {
      method: 'POST',
      body: new URLSearchParams(form)
    }).then(() => {
      e.target.reset();
      carregarPessoas();
    });
  });

  function iniciar(id) {
    fetch('/iniciar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    }).then(carregarPessoas);
  }

  function excluir(id) {
    fetch('/excluir', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    }).then(carregarPessoas);
  }

  function limparDados() {
    fetch('/limpar', { method: 'POST' })
      .then(response => {
        if (response.ok) {
          setTimeout(() => carregarPessoas(), 500);
        } else {
          alert('Erro ao limpar dados.');
        }
      });
  }

  function editarLocal(span, id) {
    const locais = ["X6", "X5", "PIAL/OFC", "VV"];
    const currentLocal = span.textContent;
    const select = document.createElement('select');
    select.className = 'form-select form-select-sm';

    locais.forEach(loc => {
      const option = document.createElement('option');
      option.value = loc;
      option.textContent = loc;
      if (loc === currentLocal) option.selected = true;
      select.appendChild(option);
    });

    span.replaceWith(select);
    select.focus();

    select.onblur = () => {
      const novoLocal = select.value;
      fetch('/editarLocal', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id, local: novoLocal })
      }).then(() => {
        select.replaceWith(span);
        span.textContent = novoLocal;
        carregarPessoas();
      }).catch(() => {
        select.replaceWith(span);
      });
    };

    select.onkeydown = e => {
      if (e.key === 'Enter') select.blur();
      if (e.key === 'Escape') select.replaceWith(span);
    };
  }

  setInterval(() => {
    if(estaEditandoId === null && !estaEditandoMensagem) {
      carregarPessoas();
    }
  }, 5000);

  carregarPessoas();
</script>

<script>
  fetch('/api/version')
    .then(res => res.ok ? res.json() : Promise.reject())
    .then(data => {
      const versionBadge = document.createElement('div');
      versionBadge.textContent = `v${data.version}`;
      Object.assign(versionBadge.style, {
        position: 'fixed',
        top: '6px',
        right: '10px',
        backgroundColor: '#888',
        color: '#fff',
        padding: '2px 6px',
        fontSize: '12px',
        borderRadius: '4px',
        fontFamily: 'Arial, sans-serif',
        zIndex: 9999,
        opacity: '0.7',
        cursor: 'default',
        userSelect: 'none'
      });
      document.body.appendChild(versionBadge);
    }).catch(() => {});
</script>

</body>
</html>
