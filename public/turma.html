<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Turma</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
<style>
  .hora-inicio, .hora-fim {
    cursor: pointer;
    user-select: none;
  }
  .segundos { color: #aaa; font-size: 0.75rem; }
  .quantidade-equipes { text-align: center; margin-bottom: 10px; font-weight: 500; }
  .btn-outline-primary { background-color: #007E7A !important; color: white !important; border-color: #007E7A !important; }
  .btn-outline-primary:hover { background-color: #00514f !important; border-color: #00514f !important; color: white !important; }
</style>
</head>
<body class="container py-4">

<header class="cabecalho-app shadow-sm rounded mb-4 px-3 py-3">
  <div class="d-flex flex-column">
    <div id="dataAtual" class="data-header mb-1"></div>
    <h1 class="titulo-app m-0 text-primary" style="color: #007E7A;">
      <img src="image/vale.png" alt="logo" class="logo"> Turma
    </h1>
    <p class="quantidade-equipes">Quantidade de pessoas: <span id="contadorPessoas">0</span></p>
  </div>
</header>

<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle text-center">
    <thead>
      <tr>
        <th>Status</th>
        <th>Pessoa</th>
        <th>Disponível</th>
        <th>Local</th>
        <th>Início</th>
        <th>Final</th>
        <th>Retorno</th>
        <th>Ações</th>
      </tr>
    </thead>
    <tbody id="tabelaCorpo"></tbody>
  </table>
</div>

<script>
function detectarSO() {
  const ua = navigator.userAgent || navigator.vendor || window.opera;
  if (/android/i.test(ua)) return 'Android';
  if (/iPad|iPhone|iPod/.test(ua) && !window.MSStream) return 'iPhone';
  if (/Win/i.test(ua)) return 'PC Windows';
  if (/Mac/i.test(ua)) return 'PC Mac';
  if (/Linux/i.test(ua)) return 'PC Linux';
  return 'Outro';
}

let estaEditandoId = null;

function carregarPessoas() {
  fetch('/pessoas')
    .then(res => res.json())
    .then(data => {
      const tbody = document.getElementById('tabelaCorpo');
      tbody.innerHTML = '';
      // Filtra apenas a lista "principal" para Turma
      const listaPrincipal = data.filter(p => p.lista === 'principal');
      document.getElementById('contadorPessoas').textContent = listaPrincipal.length;

      function formatarHora(hora) {
        if (!hora) return '-';
        return hora.replace(/(\d{2}:\d{2})(:\d{2})/, "$1<span class='segundos'>$2</span>");
      }

      listaPrincipal.forEach(p => {
        const tr = document.createElement('tr');
        tr.style.backgroundColor = p.disponivel ? '#d4edda' : '';
        tr.innerHTML = `
          <td>${p.status}</td>
          <td>${p.nome}</td>
          <td>${p.disponivel||''}</td>
          <td>${p.local}</td>
          <td class="hora-inicio" data-id="${p.id}">${formatarHora(p.hora_inicio)}</td>
          <td class="hora-fim" data-id="${p.id}">${formatarHora(p.hora_fim)}</td>
          <td>${p.retorno||''}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm" onclick="iniciar(${p.id})">Iniciar</button>
          </td>
        `;
        tbody.appendChild(tr);

        // Edição de horário
        tr.querySelector('.hora-inicio').onclick = () => editarHora(p.id, 'inicio', tr.querySelector('.hora-inicio'));
        tr.querySelector('.hora-fim').onclick = () => editarHora(p.id, 'fim', tr.querySelector('.hora-fim'));
      });
    });
}

function editarHora(id, tipo, td) {
  if (estaEditandoId) return; // evita abrir vários inputs
  estaEditandoId = id;
  const valorAtual = td.textContent.trim().slice(0,5) || '00:00';
  const input = document.createElement('input');
  input.type = 'time';
  input.value = valorAtual;
  input.style.maxWidth = '100px';
  td.innerHTML = '';
  td.appendChild(input);
  input.focus();

  input.onblur = () => {
    const novoValor = input.value;
    if (!novoValor) { estaEditandoId = null; carregarPessoas(); return; }
    // Atualiza backend
    let dados = {};
    if (tipo === 'inicio') {
      const dtInicio = novoValor + ':00';
      const dtFim = new Date(new Date().setHours(parseInt(novoValor.split(':')[0]), parseInt(novoValor.split(':')[1])+75)).toTimeString().slice(0,8);
      dados = { id, hora_inicio: dtInicio, hora_fim: dtFim };
    } else {
      dados = { id, hora_fim: novoValor + ':00' };
    }
    fetch('/editarHorario', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(dados) })
      .then(()=>{ estaEditandoId = null; carregarPessoas(); })
      .catch(()=>{ estaEditandoId = null; carregarPessoas(); });
  };

  input.onkeydown = (e) => {
    if (e.key==='Enter') input.blur();
    if (e.key==='Escape') { estaEditandoId = null; carregarPessoas(); }
  };
}

function iniciar(id){
  fetch('/iniciar', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})})
    .then(carregarPessoas);
}

setInterval(() => { if(!estaEditandoId) carregarPessoas(); }, 5000);
carregarPessoas();

// Data atual
const opcoes = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
const hoje = new Date();
document.getElementById('dataAtual').textContent = hoje.toLocaleDateString('pt-BR',opcoes).charAt(0).toUpperCase()+hoje.toLocaleDateString('pt-BR',opcoes).slice(1);
</script>

</body>
</html>
