<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>CCP</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css">
</head>
<body class="container py-4">
<header class="cabecalho-app shadow-sm rounded mb-4 px-3 py-3">
  <div class="d-flex flex-column ">
      <div id="dataAtual" class="data-header mb-1"></div>
    <h1 class="titulo-app m-0 text-primary" style="color: #007E7A;"> <img src="image/vale.png" alt="logo" class="logo"> CCP</h1>
  </div>
</header>

<div class="table-responsive">
  <table class="table table-bordered table-hover align-middle text-center">
    <thead>
      <tr>
        <th>Status</th>
        <th>Pessoa</th>
        <th>Disponível</th>
        <th>Local</th>
        <th>Início</th>
        <th>Final</th>
        <th>Retorno</th>
        <th>Mensagem</th>
      </tr>
    </thead>
    <tbody id="tabelaCorpo"></tbody>
  </table>
</div>

<script>
function carregarPessoas(){
  fetch('/pessoas').then(r=>r.json()).then(data=>{
    const tbody = document.getElementById('tabelaCorpo');
    tbody.innerHTML='';
    const lista=data['principal']||[];
    lista.forEach(p=>{
      const tr = document.createElement('tr');
      tr.style.backgroundColor = p.disponivel ? '#d4edda' : '';
      tr.innerHTML=`
        <td>${p.status}</td>
        <td>${p.nome}</td>
        <td><input type="text" value="${p.disponivel||''}" style="width:80px"/></td>
        <td>${p.local}</td>
        <td>${p.hora_inicio||'-'}</td>
        <td>${p.hora_fim||'-'}</td>
        <td>${p.retorno||'-'}</td>
        <td contenteditable="true">${p.mensagem||''}</td>
      `;
      tbody.appendChild(tr);

      // Disponível editar
      const inputDisp = tr.children[2].children[0];
      inputDisp.onblur=()=>fetch('/editarDisponivel',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:p.id,disponivel:inputDisp.value})}).then(()=>{ if(inputDisp.value) tr.style.backgroundColor='#d4edda'; else tr.style.backgroundColor=''; });

      // Mensagem CCP
      tr.children[7].onblur=()=>fetch('/enviarMensagem',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({id:p.id,mensagem:tr.children[7].textContent.trim()})});
    });
  });
}

setInterval(carregarPessoas,5000);
carregarPessoas();

const opcoes = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
const hoje = new Date();
document.getElementById('dataAtual').textContent = hoje.toLocaleDateString('pt-BR',opcoes).charAt(0).toUpperCase()+hoje.toLocaleDateString('pt-BR',opcoes).slice(1);
</script>
</body>
</html>
